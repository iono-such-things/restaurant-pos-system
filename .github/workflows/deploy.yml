name: Deploy Restaurant POS to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          set -e

          APP_DIR="/var/www/eats"
          REPO_URL="https://github.com/ionoi-inc/restaurant-pos-system.git"

          echo "Starting deployment..."

          if [ -d "$APP_DIR/.git" ]; then
            echo "Updating remote to org repo..."
            cd $APP_DIR
            git remote set-url origin $REPO_URL
            git fetch origin main
            git reset --hard origin/main
          else
            echo "Initial clone..."
            git clone $REPO_URL $APP_DIR
            cd $APP_DIR
          fi

          echo "Installing dependencies..."
          cd $APP_DIR
          npm install
          cd apps/backend && npm install && cd ../..
          cd apps/frontend && npm install && cd ../..

          echo "Building frontend..."
          cd apps/frontend && npm run build && cd ../..

          echo "Building backend..."
          cd apps/backend && npx prisma generate && npm run build && cd ../..

          echo "Preserving .env â€” creating only if missing..."
          if [ ! -f apps/backend/.env ]; then
            echo "PORT=3146" > apps/backend/.env
            echo "NODE_ENV=production" >> apps/backend/.env
          fi

          echo "Restarting service..."
          sudo systemctl restart restaurant-pos

          echo "Deployment complete!"
          sudo systemctl status restaurant-pos --no-pager
